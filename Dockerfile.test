FROM debian:bookworm-slim

ARG TARGETARCH
RUN apt-get update && \
    apt-get install -y wget ca-certificates gcc libc6-dev && \
    ARCH=$(dpkg --print-architecture) && \
    wget -q https://go.dev/dl/go1.18.10.linux-${ARCH}.tar.gz && \
    tar -C /usr/local -xzf go1.18.10.linux-${ARCH}.tar.gz && \
    rm go1.18.10.linux-${ARCH}.tar.gz && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

ENV PATH="/usr/local/go/bin:${PATH}"

WORKDIR /app

# Copy go mod files
COPY go.mod go.sum ./

# Download dependencies
RUN go mod download

# Copy source code
COPY . .

# Default command runs all tests
CMD ["go", "test", "-v", "./..."]
